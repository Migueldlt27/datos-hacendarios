<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>INDETEC · Datos Hacendarios (Embed API + Eventos)</title>

  <!-- Google Tag Manager (tu contenedor real) -->
  <script>
    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
      var f=d.getElementsByTagName(s)[0], j=d.createElement(s), dl=l!='dataLayer'?'&l='+l:'';
      j.async=true; j.src='https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-P6SC6N4M');
  </script>
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P6SC6N4M" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

  <!-- Power BI JavaScript API -->
  <script src="https://aka.ms/powerbi-client-js"></script>

  <style>
    html, body { height: 100%; margin: 0; background:#0b0c10; color:#e6e6e6; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;}
    header { padding:12px 16px; border-bottom:1px solid #222431; background:#111218;}
    h1 { font-size:16px; margin:0; }
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    #reportContainer { height: 72vh; border:1px solid #222431; border-radius: 12px; overflow: hidden; background:#0f1117;}
    .help { font-size: 12px; color:#bdbdbd; margin-bottom:8px;}
    label, input { font-size: 12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:10px;}
    input[type="text"] { width: 360px; padding:6px 8px; border-radius:8px; border:1px solid #222431; background:#141622; color:#e6e6e6;}
    button { padding:8px 12px; border-radius:10px; border:1px solid #222431; background:#141622; color:#e6e6e6; cursor:pointer;}
    button:hover { border-color:#4ea8de; }
    code { background:#141622; padding:2px 4px; border-radius:6px; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>INDETEC · Maestro (API Embed + Eventos GA4)</h1>
      <div class="help">Usa la <b>Power BI JavaScript API</b> para escuchar <code>pageChanged</code>, <code>loaded</code>, <code>rendered</code> y <code>dataSelected</code> y enviarlos a <code>dataLayer</code>.</div>
    </div>
  </header>

  <main class="container">
    <div class="row">
      <label>Access Token:</label><input id="accessToken" type="text" placeholder="ACCESS_TOKEN (AAD/Embed)" value="ACCESS_TOKEN_AQUI">
      <label>Embed URL:</label><input id="embedUrl" type="text" placeholder="https://app.powerbi.com/reportEmbed?reportId=...&groupId=..." value="EMBED_URL_AQUI">
      <label>Report ID:</label><input id="reportId" type="text" placeholder="REPORT_ID" value="REPORT_ID_AQUI">
      <button id="btnEmbed">Cargar/Embeder</button>
    </div>

    <div id="reportContainer"></div>
  </main>

  <script>
    // Utilidad: manda eventos a GTM/GA4
    function pushEvent(eventName, params) {
      window.dataLayer = window.dataLayer || [];
      window.dataLayer.push(Object.assign({ event: eventName, app: 'pbi_embed_api' }, params || {}));
      console.log('[dataLayer]', eventName, params || {});
    }

    const btn = document.getElementById('btnEmbed');
    const container = document.getElementById('reportContainer');

    btn.addEventListener('click', function() {
      const token = document.getElementById('accessToken').value.trim();
      const embedUrl = document.getElementById('embedUrl').value.trim();
      const reportId = document.getElementById('reportId').value.trim();

      if (!token || !embedUrl || !reportId) {
        alert('Completa Access Token, Embed URL y Report ID.');
        return;
      }

      const models = window['powerbi-client'].models;
      const config = {
        type: 'report',
        tokenType: models.TokenType.Embed,
        accessToken: token,
        embedUrl: embedUrl,
        id: reportId,
        settings: {
          panes: { filters: { visible: false }, pageNavigation: { visible: true } },
          navContentPaneEnabled: true,
          background: models.BackgroundType.Transparent
        }
      };

      // Limpia embed previo
      window.powerbi.reset(container);

      // Embebe
      const report = window.powerbi.embed(container, config);

      // Eventos
      report.on('loaded', function() { pushEvent('pbi_loaded', { report_id: reportId }); });
      report.on('rendered', function() { pushEvent('pbi_rendered', { report_id: reportId }); });

      report.on('pageChanged', function(ev) {
        try {
          const page = ev.detail.newPage;
          pushEvent('pbi_page_changed', {
            report_id: reportId,
            page_name: page.displayName || page.name,
            page_visibility: page.visibility
          });
        } catch(e) {
          pushEvent('pbi_page_changed', { report_id: reportId, error: String(e) });
        }
      });

      report.on('dataSelected', function(ev) {
        try {
          pushEvent('pbi_data_selected', {
            report_id: reportId,
            visual: (ev.detail && ev.detail.visual && ev.detail.visual.title) || 'unknown'
          });
        } catch(e) {
          pushEvent('pbi_data_selected', { report_id: reportId, error: String(e) });
        }
      });

      report.on('error', function(ev) {
        console.error(ev.detail);
        pushEvent('pbi_error', { report_id: reportId, message: ev.detail.message || 'unknown' });
      });

      pushEvent('pbi_embed_attempt', { report_id: reportId });
    });
  </script>
</body>
</html>
